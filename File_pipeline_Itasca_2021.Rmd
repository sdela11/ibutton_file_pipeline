---
title: "File_pipeline_Itasca_2021"
author: "Sara DeLaurentis"
date: "1/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'C:/Users/sbaue/coding/Itasca_project_19-20')


library(tidyverse)
library(readxl)
library(glue)
library(stringr)

```


## R Markdown

```{r }

m <- list.files("./2021_ibuttons_copy/", pattern = "*.csv")
m


file_df <- data.frame(paths = m, name = str_replace(m, ".csv",""), full_paths = list.files("./2021_ibuttons_copy/", pattern = "*.csv", full.names = TRUE))

f <- file_df$name #intermediate step, assigning "name" column to a variable to be used in g.
g <- as.data.frame(str_split_fixed(f, "_", 3))

master <- cbind(file_df,g)
colnames(master) <- c("paths", "name", "full_paths", "sensor", "serial" , "upload_date")
master

h <- read.csv("2021_ibutton_names_clean.csv") %>% 
  as.data.frame()
head(h)


master <- merge(master, h, by.x = "sensor", by.y = "button_id")

head(master)

#Create new name column with desired strings

master$new_name <- str_c(master$site, master$rep, master$position, master$sensor, master$season, sep = "_")
head(master)
view(master)

```
## Endgame:
We will be using pwalk or map2 from tidyverse to iterate the create_csv function over a list of files. We will first create the function, and then we will create the list of inputs to use with our iterating function (pwalk or map2).

## Sara's function

-function, requiring the inputs full_paths and new_name (created from a separate csv file and merged to master above). 
-create object "temps" by reading each csv file, skip the first 20 rows.
-to overcome inconsistencies with reading in iButton data from OnewireViewer: detect if date and time have been separated. If so, create a merged column and delete the separate date and time columns. ELSE: name the columns the normal way and carry on.
-column names within temps will be: "date.time", "unit", "value". Change these titles as needed.
-write a new csv using the object temps. File path will be: "./{new_name}.csv"

"./" means in working directory

## Creating the input list
create new dataframe: "df_master" by putting master through the following:
select the full_path and new_name columns, mutate the full_paths column to character.
  -we did this because R was giving us an error that full_paths needed to be a string.

Last line of code: create_csv function test on iButton 11.
It's a good idea to run a test on one file before using pwalk or map2, which will run the function over the whole set.

## Iterate
Use pwalk or map2. In this case, pwalk is fed the dataframe df_master, and will perform the function create_csv over each row.
map2 uses 2 columns (df_master$full_paths, df_master$sensor) and uses the row position to match the inputs together. Both approaches will work.

```{r }

##Sara's function: create_csv

create_csv <- function(full_paths, new_name){
  temps <- read_csv(full_paths, skip = 20)
  #print(temps[30,2])
  
  
  #if the number of characters at row 30, column 2 does not equal "C", it means the date and time were separated. Column two should ONLy have "C" in it, for units. In retrospect, I probably should have gone the other direction (separated the ones that were joined), but we'll see. This function merges date and time together (into date.time) and removes the separate date and time columns. It alse re-orders the columns after this process.
  #Other ways to do this would be testing if the number of characters in the first column is less than the lowest # used in a combined date and time column.
  
  if(temps[30,2] != "C")  {  
    colnames(temps) <- c("date", "time", "unit", "value")
   temps$date.time <- str_c(temps$date, temps$time, sep = " ")
   print("foo")
   #view(temps)
     temps$date <- NULL
     temps$time <- NULL
    temps <- temps[,c(3,1,2)]
  } else {
    colnames(temps) <- c("date.time", "unit", "value")
  }
  
  write_csv(temps, glue("./2021/{new_name}.csv"))
}

#Test the function
create_csv("./2021_ibuttons_copy/i11_3E00000069B0E841_101421.csv", "C2A_lksdfae9")


#TEST CASES for troubleshooting:

temps.z <- read.csv("./2021_ibuttons_copy/i11_3E00000069B0E841_101421.csv", skip = 20)

#potentially helpful function (number of characters)
nchar(temps.z[30,2])


colnames(temps.z) <- c("date", "time", "unit", "value")
temps.z$date.time <- str_c(temps.z$date, temps.z$time, sep = " ")
head(temps.z)
temps.z$date <- NULL
temps.z$time <- NULL
head(temps.z)



```

```{r }

#creating list of full_paths and sensors for input into the create_csv function
df_master <- master %>% 
  select(full_paths, new_name) %>% 
  mutate(full_paths = as.character(full_paths))

head(df_master)


#Iterate! If you want to see something really satisfying, open the folder that you're saving these to and watch the files pop in.

pwalk(df_master, create_csv)


map2(df_master$full_paths, df_master$sensor, create_csv)

```
